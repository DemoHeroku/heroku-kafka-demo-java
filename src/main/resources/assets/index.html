<!DOCTYPE html>
<html lang="en">
<head>
    <title>Apache Kafka on Heroku Demo</title>
    <link rel="stylesheet" href="https://www.herokucdn.com/purple/1.1.2/purple.min.css">
    <link rel="icon" href="https://www.herokucdn.com/favicon.ico">
    <script src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js"></script>
    <script src="https://npmcdn.com/react@15.5.4/dist/react.min.js"></script>
    <script src="https://npmcdn.com/react-dom@15.5.4/dist/react-dom.min.js"></script>
    <script src="https://npmcdn.com/react-websocket@2.0.0/build/index.js"></script>
    <!--script src="https://npmcdn.com/babel-core@5.8.38/browser.min.js"></script> -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://npmcdn.com/moment@2.14.1"></script>
</head>
<body>
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h1>Apache Kafka on Heroku with Java Demo</h1>
            <div id="app">
                <div class="spinner">
                    <i class="spinner__dot spinner__dot--one"></i>
                    <i class="spinner__dot spinner__dot--two"></i>
                    <i class="spinner__dot spinner__dot--three"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/babel">

class Websocket extends React.Component {

    constructor(props) {
      super(props);
      this.state = {
        ws: new WebSocket(this.props.url, this.props.protocol),
        attempts: 1
      };
    }

    logging(logline) {
      if (this.props.debug === true) {
          console.log(logline);
      }
    }

    generateInterval (k) {
        if(this.props.reconnectIntervalInMilliSeconds > 0) {
            return this.props.reconnectIntervalInMilliSeconds;
        }
        return Math.min(30, (Math.pow(2, k) - 1)) * 1000;
    }

    setupWebsocket() {
      let websocket = this.state.ws;

      websocket.onopen = () => {
        this.logging('Websocket connected');
        if (typeof this.props.onOpen === 'function') this.props.onOpen();
      };

      websocket.onmessage = (evt) => {
        this.props.onMessage(evt.data);
      };

      this.shouldReconnect = this.props.reconnect;
      websocket.onclose = () => {
        this.logging('Websocket disconnected');
        if (typeof this.props.onClose === 'function') this.props.onClose();
        if (this.shouldReconnect) {
          let time = this.generateInterval(this.state.attempts);
          this.timeoutID = setTimeout(() => {
            this.setState({attempts: this.state.attempts+1});
            this.setState({ws: new WebSocket(this.props.url, this.props.protocol)});
            this.setupWebsocket();
          }, time);
        }
      }
    }

    componentDidMount() {
      this.setupWebsocket();
    }

    componentWillUnmount() {
      this.shouldReconnect = false;
      clearTimeout(this.timeoutID);
      let websocket = this.state.ws;
      websocket.close();
    }

    sendMessage(message){
      let websocket = this.state.ws;
      websocket.send(message);
    }

    render() {
      return (
        <div></div>
      );
    }
}

Websocket.defaultProps = {
    debug: false,
    reconnect: true
};

    const Spinner = React.createClass({
        render: function () {
            if (!this.props.show) {
                return null
            }

            return (
                    <div className="spinner">
                        <i className="spinner__dot spinner__dot--one"></i>
                        <i className="spinner__dot spinner__dot--two"></i>
                        <i className="spinner__dot spinner__dot--three"></i>
                    </div>
            )
        }
    })

    const MessageTable = React.createClass({
        render: function() {

            let tableContent = '';

            if (!this.props.hasFetched) {
                tableContent = (
                        <tr>
                            <td colSpan="4">Fetching messages...</td>
                        </tr>
                )
            }

            if (this.props.hasFetched && this.props.messages.length === 0) {
                tableContent = (
                        <tr>
                            <td colSpan="4">
                                <div className="u-padding-Al u-padding-Tm u-text-center">
                                    <h3><small>Messages will appear here</small></h3>
                                    <p>Last 10 messages cached by the Kafka topic consumer.</p>
                                    <p><a href="#" className="btn btn-default" onClick={this.props.onBlankStateAction}>Send a message</a></p>
                                </div>
                            </td>
                        </tr>
                )
            }

            if (this.props.hasFetched && this.props.messages.length > 0) {
                tableContent = this.props.messages.map((m) => {
                    return (
                            <tr>
                                <td>{m.offset}</td>
                                <td>{m.message}</td>
                                <td>{m.topic}</td>
                                <td>{m.partition}</td>
                            </tr>
                    )
                })
            }

            return (
                    <div>
                        <div className="row">
                            <div className="col-md-6">
                                <h5>Recent Messages <small>Refreshes every 5 seconds <Spinner show={this.props.fetching} /></small></h5>
                            </div>
                            <div className="col-md-6 text-right">
                                <h5>

                                </h5>
                            </div>
                        </div>
                        <div className="purple-box u-padding-Am u-padding-Bs u-margin-Bm">
                            <table className="table">
                                <thead>
                                    <tr>
                                        <th>Offset</th>
                                        <th>Message</th>
                                        <th>Topic</th>
                                        <th>Partition</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {tableContent}
                                </tbody>
                            </table>
                        </div>
                    </div>
            )
        }
    })

    const InputForm = React.createClass({
        getInitialState: function() {
            return {
                message: ''
            }
        },

        handleMessageChange: function(e) {
            this.setState({ message: e.target.value })
        },

        handleSubmit: function(e) {
            e.preventDefault()
            const message = this.state.message
            if (!message) {
                return
            }

            axios.post('/api/messages', { message: message }).then(() => {
                this.setState({ message: '' })
            })
        },

        render: function() {
            return (
                    <div className="purple-box u-padding-Am u-padding-Bs u-margin-Bm">
                        <form className="form" onSubmit={this.handleSubmit}>
                            <div className="form-group">
                                <div className="input-group">
                                    <input type="text" ref="inputField" className="form-control" value={this.state.message} onChange={this.handleMessageChange} placeholder="Type a message..." />
                                    <span className="input-group-btn">
                                        <button className="btn btn-primary" type="submit">Send</button>
                                    </span>
                                </div>
                            </div>
                        </form>
                    </div>
            )
        }
    })

    const App = React.createClass({
        getInitialState: function() {
            return {
                messages: [],
                hasFetched: false,
                isInputting: true
            }
        },

        componentDidMount: function() {
            // this.fetchMessages()
        },

        handleBlankStateAction: function (e) {
            e.preventDefault()
            this.refs.inputForm.refs.inputField.focus()
        },

        handleData(data) {
            var result = this.state.messages.concat([{message: data, topic: "messages", partition: 0}])
            // let result = JSON.parse(data)
            this.setState({
                messages: result,
                fetching: false,
                hasFetched:true
            })
        },

        fetchMessages: function() {
            this.setState({ fetching: true })
            axios.get('/api/messages')
                    .then((response) => {
                        this.setState({
                            messages: response.data,
                            fetching: false,
                            hasFetched: true
                        })
                        setTimeout(this.fetchMessages, 1000)
                    })

            // TODO: handle failure
        },

        render: function() {
            return (
                    <div>
                        <InputForm onMessageSaved={this.handleMessageSaved} ref="inputForm" />
                        <MessageTable messages={this.state.messages} fetching={this.state.fetching} hasFetched={this.state.hasFetched} onBlankStateAction={this.handleBlankStateAction} />
                        <Websocket url='ws://localhost:8080/events' onMessage={this.handleData.bind(this)} />
                    </div>
            )
        }
    })

    ReactDOM.render(
            <App />,
            document.getElementById('app')
    );
</script>
</body>
</html>
